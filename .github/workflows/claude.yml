name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
  issues:
    types: [opened, assigned]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  claude-assistant:
    # Run when @claude is mentioned or on new PRs for review
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request' && github.event.action == 'opened') ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Auto-review new PRs
          prompt: ${{ github.event_name == 'pull_request' && 'Review this PR. Check for bugs, code style issues, and suggest improvements. Be concise.' || '' }}
          claude_args: "--max-turns 5"

  # Optional: Auto-review on PR changes
  code-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this pull request:
            1. Check for potential bugs or issues
            2. Verify code follows project conventions (see CLAUDE.md)
            3. Suggest improvements if any
            4. Be concise and actionable
            
            If the changes look good, just say "LGTM" with a brief summary.
          claude_args: "--max-turns 3"
