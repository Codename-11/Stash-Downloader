name: Claude Assistant

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  # Stage 1: Validation - Determine what action to take
  validate:
    runs-on: ubuntu-latest
    outputs:
      should_review: ${{ steps.check.outputs.should_review }}
      should_respond: ${{ steps.check.outputs.should_respond }}
      is_pr: ${{ steps.check.outputs.is_pr }}
    steps:
      - name: Check triggers
        id: check
        run: |
          # Check if this is a PR that needs review
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_review=true" >> $GITHUB_OUTPUT
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "should_review=false" >> $GITHUB_OUTPUT
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

          # Check if @claude was mentioned
          MENTIONED=false
          if [[ "${{ github.event_name }}" == "issue_comment" && "${{ contains(github.event.comment.body, '@claude') }}" == "true" ]]; then
            MENTIONED=true
          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" && "${{ contains(github.event.comment.body, '@claude') }}" == "true" ]]; then
            MENTIONED=true
          elif [[ "${{ github.event_name }}" == "pull_request_review" && "${{ contains(github.event.review.body, '@claude') }}" == "true" ]]; then
            MENTIONED=true
          elif [[ "${{ github.event_name }}" == "issues" && ("${{ contains(github.event.issue.body, '@claude') }}" == "true" || "${{ contains(github.event.issue.title, '@claude') }}" == "true") ]]; then
            MENTIONED=true
          fi

          echo "should_respond=$MENTIONED" >> $GITHUB_OUTPUT

          echo "Should review: ${{ github.event_name == 'pull_request' }}"
          echo "Should respond: $MENTIONED"

  # Stage 2: Code Review - Automated PR review
  code-review:
    needs: validate
    if: needs.validate.outputs.should_review == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
        continue-on-error: true

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this PR against CLAUDE.md standards. Be concise and constructive.

  # Stage 3: Interactive Response - Respond to @claude mentions
  respond:
    needs: validate
    if: needs.validate.outputs.should_respond == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Response
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
          # No prompt - Claude will respond to the mention naturally
