name: CI/CD

on:
  push:
    branches: [main, dev]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_dev:
        description: 'Deploy as dev build'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ============================================================================
  # TEST JOB - Runs on all pushes and PRs
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npx eslint src --max-warnings 60

      - name: Run tests
        run: npm test -- --run

      - name: Build
        run: npm run build

  # ============================================================================
  # DEPLOY STABLE - Only runs on version tags (v*)
  # ============================================================================
  deploy-stable:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building STABLE version: ${VERSION}"

      - name: Create stable plugin package
        run: |
          mkdir -p _site _package

          # Copy plugin files to package directory (flat structure)
          cp -r dist _package/
          cp -r scripts _package/
          cp stash-downloader.yml _package/
          cp README.md _package/
          cp LICENSE _package/

          # Create ZIP file (contents at root, not nested in folder)
          cd _package
          zip -r ../stash-downloader.zip .
          cd ..

          # Move ZIP to _site directory
          mv stash-downloader.zip _site/

      - name: Fetch existing dev build
        continue-on-error: true
        run: |
          PAGES_URL="https://codename-11.github.io/Stash-Downloader"

          # Preserve dev zip if it exists
          curl -fsSL "${PAGES_URL}/stash-downloader-dev.zip" -o _site/stash-downloader-dev.zip || echo "No existing dev zip"

          # Fetch existing index to get dev entry metadata
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || echo "No existing index"

      - name: Generate plugin index
        run: |
          CURRENT_DATETIME=$(date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}
          STABLE_SHA256=$(sha256sum _site/stash-downloader.zip | awk '{print $1}')

          # Start with stable entry
          cat > _site/index.yml << EOF
          - id: stash-downloader
            name: Stash Downloader
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-downloader.zip
            sha256: ${STABLE_SHA256}
            description: Download images and videos from URLs with automatic metadata extraction
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Append dev entry if it exists
          if [[ -f _site/stash-downloader-dev.zip ]]; then
            DEV_SHA256=$(sha256sum _site/stash-downloader-dev.zip | awk '{print $1}')
            DEV_VERSION=$(grep -A1 "id: stash-downloader-dev" /tmp/existing-index.yml 2>/dev/null | grep "version:" | awk '{print $2}' || echo "${VERSION}-dev")
            DEV_DATE=$(grep -A3 "id: stash-downloader-dev" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: //' || echo "${CURRENT_DATETIME}")

            cat >> _site/index.yml << EOF
          - id: stash-downloader-dev
            name: Stash Downloader (Dev)
            version: ${DEV_VERSION}
            date: ${DEV_DATE}
            path: stash-downloader-dev.zip
            sha256: ${DEV_SHA256}
            description: "[DEV] Download images/videos with metadata extraction - Development build"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          echo "Generated index.yml:"
          cat _site/index.yml

      - name: List _site contents
        run: ls -la _site/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Upload ZIP artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: stable-plugin-zip
          path: _site/stash-downloader.zip

  # ============================================================================
  # DEPLOY DEV - Runs on dev branch or workflow_dispatch with deploy_dev=true
  # ============================================================================
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/dev' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_dev)
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Modify source for dev build
        run: |
          echo "=== MODIFYING SOURCE FILES FOR DEV BUILD ==="

          echo "Before modification (constants):"
          grep -n "PLUGIN_ID\|MAIN:" src/constants/index.ts | head -5

          # Update constants - plugin ID, name, routes, storage keys
          sed -i 's/stash-downloader/stash-downloader-dev/g' src/constants/index.ts
          sed -i 's/Stash Downloader/Stash Downloader (Dev)/g' src/constants/index.ts

          # Update index.tsx - style ID and nav button ID
          sed -i 's/stash-downloader-styles/stash-downloader-dev-styles/g' src/index.tsx
          sed -i 's/stash-downloader-nav-button/stash-downloader-dev-nav-button/g' src/index.tsx

          # Update plugin YAML
          sed -i 's/name: Stash Downloader$/name: Stash Downloader (Dev)/g' stash-downloader.yml

          echo ""
          echo "After modification (constants):"
          grep -n "PLUGIN_ID\|MAIN:" src/constants/index.ts | head -5

          echo ""
          echo "After modification (index.tsx):"
          grep -n "stash-downloader-dev" src/index.tsx | head -3

          echo ""
          echo "After modification (YAML):"
          grep -n "name:" stash-downloader.yml | head -2

          echo "=== MODIFICATION COMPLETE ==="

      - name: Build plugin
        run: npm run build

      - name: Get version
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          VERSION="${BASE_VERSION}-dev.${SHORT_SHA}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building DEV version: ${VERSION}"

      - name: Create dev plugin package
        run: |
          mkdir -p _site _package

          # Copy plugin files to package directory (flat structure)
          cp -r dist _package/
          cp -r scripts _package/
          cp stash-downloader.yml _package/
          cp README.md _package/
          cp LICENSE _package/

          # Rename YAML for dev builds (Stash uses YAML filename as plugin ID)
          mv _package/stash-downloader.yml _package/stash-downloader-dev.yml
          echo "Renamed YAML to stash-downloader-dev.yml for unique plugin ID"

          # Create ZIP file (contents at root, not nested in folder)
          cd _package
          zip -r ../stash-downloader-dev.zip .
          cd ..

          # Move ZIP to _site directory
          mv stash-downloader-dev.zip _site/

      - name: Fetch existing stable build
        continue-on-error: true
        run: |
          PAGES_URL="https://codename-11.github.io/Stash-Downloader"

          # Preserve stable zip if it exists
          curl -fsSL "${PAGES_URL}/stash-downloader.zip" -o _site/stash-downloader.zip || echo "No existing stable zip"

          # Fetch existing index to get stable entry metadata
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || echo "No existing index"

      - name: Generate plugin index
        run: |
          CURRENT_DATETIME=$(date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}
          BASE_VERSION=$(node -p "require('./package.json').version")
          DEV_SHA256=$(sha256sum _site/stash-downloader-dev.zip | awk '{print $1}')

          # Start with dev entry
          cat > _site/index.yml << EOF
          - id: stash-downloader-dev
            name: Stash Downloader (Dev)
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-downloader-dev.zip
            sha256: ${DEV_SHA256}
            description: "[DEV] Download images/videos with metadata extraction - Development build"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Append stable entry if it exists
          if [[ -f _site/stash-downloader.zip ]]; then
            STABLE_SHA256=$(sha256sum _site/stash-downloader.zip | awk '{print $1}')
            STABLE_VERSION=$(grep -A1 "id: stash-downloader$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | awk '{print $2}' || echo "${BASE_VERSION}")
            STABLE_DATE=$(grep -A3 "id: stash-downloader$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: //' || echo "${CURRENT_DATETIME}")

            cat >> _site/index.yml << EOF
          - id: stash-downloader
            name: Stash Downloader
            version: ${STABLE_VERSION}
            date: ${STABLE_DATE}
            path: stash-downloader.zip
            sha256: ${STABLE_SHA256}
            description: Download images and videos from URLs with automatic metadata extraction
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          echo "Generated index.yml:"
          cat _site/index.yml

      - name: List _site contents
        run: ls -la _site/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  # ============================================================================
  # RELEASE - Only runs on version tags (v*) after stable deployment
  # ============================================================================
  release:
    needs: deploy-stable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Download stable ZIP
        uses: actions/download-artifact@v4
        with:
          name: stable-plugin-zip

      - name: Get commits since last release
        id: commits
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --oneline --no-decorate -50)
          else
            echo "Previous tag: $PREV_TAG"
            COMMITS=$(git log --oneline --no-decorate ${PREV_TAG}..HEAD)
          fi

          # Save to file for Claude (avoids escaping issues)
          echo "$COMMITS" > /tmp/commits.txt
          echo "commits_file=/tmp/commits.txt" >> $GITHUB_OUTPUT

          # Also save for fallback
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate release summary with Gemini
        id: summary
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          COMMITS=$(cat /tmp/commits.txt)
          VERSION="${{ needs.deploy-stable.outputs.version }}"

          # Skip if no API key configured
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "No GOOGLE_API_KEY configured, skipping AI summary"
            echo "has_summary=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build prompt
          PROMPT="Generate release notes for Stash Downloader v${VERSION}, a plugin for Stash (media organization software).

          Commits since last release:
          ${COMMITS}

          Instructions:
          - Write 3-6 bullet points summarizing the most important changes
          - Group related commits into single bullet points
          - Use simple language, focus on user-facing changes
          - Start each bullet with an emoji: âœ¨ for features, ðŸ› for fixes, âš¡ for improvements, ðŸ”§ for maintenance
          - Do NOT include commit hashes
          - Do NOT mention 'chore' or 'refactor' unless user-visible
          - Keep it brief - one line per bullet point
          - Output ONLY the bullet points, no headers or extra text"

          # Call Gemini API (free tier: 15 req/min, 1M tokens/day)
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GOOGLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                contents: [{parts: [{text: $prompt}]}],
                generationConfig: {maxOutputTokens: 500}
              }')")

          # Extract text from Gemini response
          SUMMARY=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$SUMMARY" ]; then
            echo "Gemini API error or empty response:"
            echo "$RESPONSE" | head -c 500
            echo "has_summary=false" >> $GITHUB_OUTPUT
          else
            echo "$SUMMARY" > /tmp/summary.txt
            echo "has_summary=true" >> $GITHUB_OUTPUT
            echo "Generated summary:"
            cat /tmp/summary.txt
          fi

      - name: Build release body
        id: body
        run: |
          VERSION="${{ needs.deploy-stable.outputs.version }}"

          # Start with header
          cat > /tmp/release_body.md << 'HEADER'
          ## ðŸš€ Stash Downloader v
          HEADER
          # Append version (avoiding heredoc variable issues)
          sed -i "s/v$/v${VERSION}/" /tmp/release_body.md

          # Add AI summary if available
          if [ "${{ steps.summary.outputs.has_summary }}" = "true" ]; then
            echo "" >> /tmp/release_body.md
            echo "### âœ¨ What's New" >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
            cat /tmp/summary.txt >> /tmp/release_body.md
            echo "" >> /tmp/release_body.md
          fi

          # Add installation instructions
          cat >> /tmp/release_body.md << 'FOOTER'

          ### ðŸ“¦ Installation

          **Via Stash Plugin Manager (Recommended):**
          1. Settings â†’ Plugins â†’ Available Plugins â†’ Add Source
          2. Enter: `https://codename-11.github.io/Stash-Downloader/index.yml`
          3. Find "Stash Downloader" and click Install

          **Manual Installation:**
          1. Download `stash-downloader.zip` below
          2. Extract to `~/.stash/plugins/stash-downloader/`
          3. Reload plugins in Stash

          ### ðŸ“‹ Requirements
          - Stash v0.20+
          - Python 3.7+ with yt-dlp (`pip install yt-dlp`)

          ---

          FOOTER

          echo "Generated release body:"
          cat /tmp/release_body.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.deploy-stable.outputs.version }}
          body_path: /tmp/release_body.md
          files: stash-downloader.zip
          draft: false
          prerelease: false
