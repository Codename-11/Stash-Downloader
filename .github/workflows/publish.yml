name: CI/CD

on:
  push:
    branches: [dev]
    tags:
      - 'downloader-v*'  # Stash Downloader releases
      - 'browser-v*'     # Stash Browser releases
      - 'tagger-v*'      # Stash Tagger releases
      - 'extension-v*'   # Firefox Extension releases
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_dev:
        description: 'Deploy as dev build'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  PAGES_URL: "https://codename-11.github.io/Stash-Downloader"

jobs:
  # ============================================================================
  # TEST JOB - Runs on all pushes and PRs
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Run tests (Downloader)
        run: npm test -- --run
        working-directory: plugins/stash-downloader

      - name: Build all plugins
        run: npm run build

  # ============================================================================
  # DEPLOY DEV - Builds BOTH plugins on dev branch push
  # ============================================================================
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/dev' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_dev)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get versions
        id: versions
        run: |
          DOWNLOADER_VERSION=$(node -p "require('./plugins/stash-downloader/package.json').version")
          BROWSER_VERSION=$(node -p "require('./plugins/stash-browser/package.json').version")
          TAGGER_VERSION=$(node -p "require('./plugins/stash-tagger/package.json').version")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          echo "downloader_version=${DOWNLOADER_VERSION}-dev.${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "browser_version=${BROWSER_VERSION}-dev.${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "tagger_version=${TAGGER_VERSION}-dev.${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "downloader_base=${DOWNLOADER_VERSION}" >> $GITHUB_OUTPUT
          echo "browser_base=${BROWSER_VERSION}" >> $GITHUB_OUTPUT
          echo "tagger_base=${TAGGER_VERSION}" >> $GITHUB_OUTPUT

      - name: Modify Downloader source for dev
        run: |
          sed -i 's/stash-downloader/stash-downloader-dev/g' plugins/stash-downloader/src/constants/index.ts
          sed -i 's/Stash Downloader/Stash Downloader (Dev)/g' plugins/stash-downloader/src/constants/index.ts
          sed -i 's/stash-downloader-styles/stash-downloader-dev-styles/g' plugins/stash-downloader/src/index.tsx
          sed -i 's/stash-downloader-nav-button/stash-downloader-dev-nav-button/g' plugins/stash-downloader/src/index.tsx
          sed -i 's/name: Stash Downloader$/name: Stash Downloader (Dev)/g' plugins/stash-downloader/stash-downloader.yml
          cd plugins/stash-downloader && npm version ${{ steps.versions.outputs.downloader_version }} --no-git-tag-version --allow-same-version

      - name: Modify Browser source for dev
        run: |
          sed -i 's/stash-browser/stash-browser-dev/g' plugins/stash-browser/src/constants/index.ts
          sed -i 's/Stash Browser/Stash Browser (Dev)/g' plugins/stash-browser/src/constants/index.ts
          sed -i 's/name: Stash Browser$/name: Stash Browser (Dev)/g' plugins/stash-browser/stash-browser.yml
          cd plugins/stash-browser && npm version ${{ steps.versions.outputs.browser_version }} --no-git-tag-version --allow-same-version

      - name: Modify Tagger source for dev
        run: |
          sed -i 's/stash-tagger/stash-tagger-dev/g' plugins/stash-tagger/src/constants/index.ts
          sed -i 's/Stash Tagger/Stash Tagger (Dev)/g' plugins/stash-tagger/src/constants/index.ts
          sed -i 's/name: Stash Tagger$/name: Stash Tagger (Dev)/g' plugins/stash-tagger/stash-tagger.yml
          cd plugins/stash-tagger && npm version ${{ steps.versions.outputs.tagger_version }} --no-git-tag-version --allow-same-version

      - name: Build all plugins
        run: npm run build

      - name: Create dev packages
        run: |
          mkdir -p _site

          # Package Stash Downloader Dev
          mkdir -p _pkg_downloader
          cp -r plugins/stash-downloader/dist _pkg_downloader/
          cp -r plugins/stash-downloader/scripts _pkg_downloader/
          cp plugins/stash-downloader/stash-downloader.yml _pkg_downloader/stash-downloader-dev.yml
          cp README.md LICENSE _pkg_downloader/
          cd _pkg_downloader && zip -r ../stash-downloader-dev.zip . && cd ..
          mv stash-downloader-dev.zip _site/

          # Package Stash Browser Dev
          mkdir -p _pkg_browser
          cp -r plugins/stash-browser/dist _pkg_browser/
          cp -r plugins/stash-browser/scripts _pkg_browser/
          cp plugins/stash-browser/stash-browser.yml _pkg_browser/stash-browser-dev.yml
          cp LICENSE _pkg_browser/
          cd _pkg_browser && zip -r ../stash-browser-dev.zip . && cd ..
          mv stash-browser-dev.zip _site/

          # Package Stash Tagger Dev
          mkdir -p _pkg_tagger
          cp -r plugins/stash-tagger/dist _pkg_tagger/
          cp plugins/stash-tagger/stash-tagger.yml _pkg_tagger/stash-tagger-dev.yml
          cp LICENSE _pkg_tagger/
          cd _pkg_tagger && zip -r ../stash-tagger-dev.zip . && cd ..
          mv stash-tagger-dev.zip _site/

      - name: Fetch existing stable builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader.zip" -o _site/stash-downloader.zip || echo "No existing downloader stable"
          curl -fsSL "${PAGES_URL}/stash-browser.zip" -o _site/stash-browser.zip || echo "No existing browser stable"
          curl -fsSL "${PAGES_URL}/stash-tagger.zip" -o _site/stash-tagger.zip || echo "No existing tagger stable"
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || echo "No existing index"

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')

          # Start fresh index
          echo "" > _site/index.yml

          # Downloader Dev
          HASH=$(sha256sum _site/stash-downloader-dev.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-downloader-dev
            name: Stash Downloader (Dev)
            version: ${{ steps.versions.outputs.downloader_version }}
            date: ${CURRENT_DATETIME}
            path: stash-downloader-dev.zip
            sha256: ${HASH}
            description: "[DEV] Download images/videos with metadata extraction"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Downloader Stable (if exists)
          if [[ -f _site/stash-downloader.zip ]]; then
            HASH=$(sha256sum _site/stash-downloader.zip | awk '{print $1}')
            VERSION=$(grep -A1 "id: stash-downloader$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | sed 's/.*version: *//' | tr -d '[:space:]')
            DATE=$(grep -A3 "id: stash-downloader$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: *//')
            [[ -z "$VERSION" ]] && VERSION="${{ steps.versions.outputs.downloader_base }}"
            [[ -z "$DATE" ]] && DATE="${CURRENT_DATETIME}"
            cat >> _site/index.yml << EOF
          - id: stash-downloader
            name: Stash Downloader
            version: ${VERSION}
            date: ${DATE}
            path: stash-downloader.zip
            sha256: ${HASH}
            description: Download images and videos from URLs with automatic metadata extraction
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          # Browser Dev
          HASH=$(sha256sum _site/stash-browser-dev.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-browser-dev
            name: Stash Browser (Dev)
            version: ${{ steps.versions.outputs.browser_version }}
            date: ${CURRENT_DATETIME}
            path: stash-browser-dev.zip
            sha256: ${HASH}
            description: "[DEV] Browse and preview content from external sources"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Browser Stable (if exists)
          if [[ -f _site/stash-browser.zip ]]; then
            HASH=$(sha256sum _site/stash-browser.zip | awk '{print $1}')
            VERSION=$(grep -A1 "id: stash-browser$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | sed 's/.*version: *//' | tr -d '[:space:]')
            DATE=$(grep -A3 "id: stash-browser$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: *//')
            [[ -z "$VERSION" ]] && VERSION="${{ steps.versions.outputs.browser_base }}"
            [[ -z "$DATE" ]] && DATE="${CURRENT_DATETIME}"
            cat >> _site/index.yml << EOF
          - id: stash-browser
            name: Stash Browser
            version: ${VERSION}
            date: ${DATE}
            path: stash-browser.zip
            sha256: ${HASH}
            description: Browse and preview content from external sources
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          # Tagger Dev
          HASH=$(sha256sum _site/stash-tagger-dev.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-tagger-dev
            name: Stash Tagger (Dev)
            version: ${{ steps.versions.outputs.tagger_version }}
            date: ${CURRENT_DATETIME}
            path: stash-tagger-dev.zip
            sha256: ${HASH}
            description: "[DEV] Match studios, performers, and tags from StashBox"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Tagger Stable (if exists)
          if [[ -f _site/stash-tagger.zip ]]; then
            HASH=$(sha256sum _site/stash-tagger.zip | awk '{print $1}')
            VERSION=$(grep -A1 "id: stash-tagger$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | sed 's/.*version: *//' | tr -d '[:space:]')
            DATE=$(grep -A3 "id: stash-tagger$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: *//')
            [[ -z "$VERSION" ]] && VERSION="${{ steps.versions.outputs.tagger_base }}"
            [[ -z "$DATE" ]] && DATE="${CURRENT_DATETIME}"
            cat >> _site/index.yml << EOF
          - id: stash-tagger
            name: Stash Tagger
            version: ${VERSION}
            date: ${DATE}
            path: stash-tagger.zip
            sha256: ${HASH}
            description: Match studios, performers, and tags from StashBox
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          echo "Generated index.yml:"
          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

  # ============================================================================
  # DEPLOY DOWNLOADER STABLE - Only on downloader-v* tags
  # ============================================================================
  deploy-downloader-stable:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/downloader-v')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Get versions
        id: version
        run: |
          VERSION=$(node -p "require('./plugins/stash-downloader/package.json').version")
          BROWSER_VERSION=$(node -p "require('./plugins/stash-browser/package.json').version")
          TAGGER_VERSION=$(node -p "require('./plugins/stash-tagger/package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "browser_version=${BROWSER_VERSION}" >> $GITHUB_OUTPUT
          echo "tagger_version=${TAGGER_VERSION}" >> $GITHUB_OUTPUT

      - name: Create package
        run: |
          mkdir -p _site _package
          cp -r plugins/stash-downloader/dist _package/
          cp -r plugins/stash-downloader/scripts _package/
          cp plugins/stash-downloader/stash-downloader.yml _package/
          cp README.md LICENSE _package/
          cd _package && zip -r ../stash-downloader.zip . && cd ..
          mv stash-downloader.zip _site/

      - name: Fetch existing builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader-dev.zip" -o _site/stash-downloader-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser.zip" -o _site/stash-browser.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser-dev.zip" -o _site/stash-browser-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-tagger.zip" -o _site/stash-tagger.zip || true
          curl -fsSL "${PAGES_URL}/stash-tagger-dev.zip" -o _site/stash-tagger-dev.zip || true
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || true

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}

          echo "" > _site/index.yml

          # Downloader Stable (NEW)
          HASH=$(sha256sum _site/stash-downloader.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-downloader
            name: Stash Downloader
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-downloader.zip
            sha256: ${HASH}
            description: Download images and videos from URLs with automatic metadata extraction
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Version fallbacks from current package.json (not 0.0.0)
          BROWSER_FALLBACK="${{ steps.version.outputs.browser_version }}"
          DOWNLOADER_FALLBACK="${{ steps.version.outputs.version }}"
          TAGGER_FALLBACK="${{ steps.version.outputs.tagger_version }}"

          # Preserve other entries with proper fallbacks
          for entry in "stash-downloader-dev" "stash-browser" "stash-browser-dev" "stash-tagger" "stash-tagger-dev"; do
            ZIP="_site/${entry}.zip"
            if [[ -f "$ZIP" ]]; then
              HASH=$(sha256sum "$ZIP" | awk '{print $1}')

              # Extract values with proper empty handling (version is 2 lines after id)
              VERSION_ENTRY=$(grep -A2 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | sed 's/.*version: *//' | tr -d '[:space:]')
              DATE_ENTRY=$(grep -A3 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: *//')
              NAME=$(grep -A1 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "name:" | sed 's/.*name: *//')
              DESC=$(grep -A6 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "description:" | sed 's/.*description: *//')

              # Apply fallbacks - use package.json versions for STABLE entries only
              # Dev entries should keep their -dev.sha suffix from existing index
              if [[ -z "$VERSION_ENTRY" ]]; then
                if [[ "$entry" == *"browser"* ]]; then
                  VERSION_ENTRY="${BROWSER_FALLBACK}"
                elif [[ "$entry" == *"tagger"* ]]; then
                  VERSION_ENTRY="${TAGGER_FALLBACK}"
                else
                  VERSION_ENTRY="${DOWNLOADER_FALLBACK}"
                fi
              fi
              [[ -z "$DATE_ENTRY" ]] && DATE_ENTRY="${CURRENT_DATETIME}"
              [[ -z "$NAME" ]] && NAME="${entry}"
              [[ -z "$DESC" ]] && DESC="Stash plugin"

              cat >> _site/index.yml << EOF
          - id: ${entry}
            name: ${NAME}
            version: ${VERSION_ENTRY}
            date: ${DATE_ENTRY}
            path: ${entry}.zip
            sha256: ${HASH}
            description: ${DESC}
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
            fi
          done

          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: downloader-stable-zip
          path: _site/stash-downloader.zip

  # ============================================================================
  # DEPLOY BROWSER STABLE - Only on browser-v* tags
  # ============================================================================
  deploy-browser-stable:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/browser-v')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Get versions
        id: version
        run: |
          VERSION=$(node -p "require('./plugins/stash-browser/package.json').version")
          DOWNLOADER_VERSION=$(node -p "require('./plugins/stash-downloader/package.json').version")
          TAGGER_VERSION=$(node -p "require('./plugins/stash-tagger/package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "downloader_version=${DOWNLOADER_VERSION}" >> $GITHUB_OUTPUT
          echo "tagger_version=${TAGGER_VERSION}" >> $GITHUB_OUTPUT

      - name: Create package
        run: |
          mkdir -p _site _package
          cp -r plugins/stash-browser/dist _package/
          cp -r plugins/stash-browser/scripts _package/
          cp plugins/stash-browser/stash-browser.yml _package/
          cp LICENSE _package/
          cd _package && zip -r ../stash-browser.zip . && cd ..
          mv stash-browser.zip _site/

      - name: Fetch existing builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader.zip" -o _site/stash-downloader.zip || true
          curl -fsSL "${PAGES_URL}/stash-downloader-dev.zip" -o _site/stash-downloader-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser-dev.zip" -o _site/stash-browser-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-tagger.zip" -o _site/stash-tagger.zip || true
          curl -fsSL "${PAGES_URL}/stash-tagger-dev.zip" -o _site/stash-tagger-dev.zip || true
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || true

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}

          echo "" > _site/index.yml

          # Browser Stable (NEW)
          HASH=$(sha256sum _site/stash-browser.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-browser
            name: Stash Browser
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-browser.zip
            sha256: ${HASH}
            description: Browse and preview content from external sources
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Version fallbacks from current package.json (not 0.0.0)
          BROWSER_FALLBACK="${{ steps.version.outputs.version }}"
          DOWNLOADER_FALLBACK="${{ steps.version.outputs.downloader_version }}"
          TAGGER_FALLBACK="${{ steps.version.outputs.tagger_version }}"

          # Preserve other entries with proper fallbacks
          for entry in "stash-downloader" "stash-downloader-dev" "stash-browser-dev" "stash-tagger" "stash-tagger-dev"; do
            ZIP="_site/${entry}.zip"
            if [[ -f "$ZIP" ]]; then
              HASH=$(sha256sum "$ZIP" | awk '{print $1}')

              # Extract values with proper empty handling (version is 2 lines after id)
              VERSION_ENTRY=$(grep -A2 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | sed 's/.*version: *//' | tr -d '[:space:]')
              DATE_ENTRY=$(grep -A3 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: *//')
              NAME=$(grep -A1 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "name:" | sed 's/.*name: *//')
              DESC=$(grep -A6 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "description:" | sed 's/.*description: *//')

              # Apply fallbacks - use package.json versions for STABLE entries only
              # Dev entries should keep their -dev.sha suffix from existing index
              if [[ -z "$VERSION_ENTRY" ]]; then
                if [[ "$entry" == *"browser"* ]]; then
                  VERSION_ENTRY="${BROWSER_FALLBACK}"
                elif [[ "$entry" == *"tagger"* ]]; then
                  VERSION_ENTRY="${TAGGER_FALLBACK}"
                else
                  VERSION_ENTRY="${DOWNLOADER_FALLBACK}"
                fi
              fi
              [[ -z "$DATE_ENTRY" ]] && DATE_ENTRY="${CURRENT_DATETIME}"
              [[ -z "$NAME" ]] && NAME="${entry}"
              [[ -z "$DESC" ]] && DESC="Stash plugin"

              cat >> _site/index.yml << EOF
          - id: ${entry}
            name: ${NAME}
            version: ${VERSION_ENTRY}
            date: ${DATE_ENTRY}
            path: ${entry}.zip
            sha256: ${HASH}
            description: ${DESC}
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
            fi
          done

          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: browser-stable-zip
          path: _site/stash-browser.zip

  # ============================================================================
  # DEPLOY TAGGER STABLE - Only on tagger-v* tags
  # ============================================================================
  deploy-tagger-stable:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/tagger-v')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Get versions
        id: version
        run: |
          VERSION=$(node -p "require('./plugins/stash-tagger/package.json').version")
          DOWNLOADER_VERSION=$(node -p "require('./plugins/stash-downloader/package.json').version")
          BROWSER_VERSION=$(node -p "require('./plugins/stash-browser/package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "downloader_version=${DOWNLOADER_VERSION}" >> $GITHUB_OUTPUT
          echo "browser_version=${BROWSER_VERSION}" >> $GITHUB_OUTPUT

      - name: Create package
        run: |
          mkdir -p _site _package
          cp -r plugins/stash-tagger/dist _package/
          cp plugins/stash-tagger/stash-tagger.yml _package/
          cp LICENSE _package/
          cd _package && zip -r ../stash-tagger.zip . && cd ..
          mv stash-tagger.zip _site/

      - name: Fetch existing builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader.zip" -o _site/stash-downloader.zip || true
          curl -fsSL "${PAGES_URL}/stash-downloader-dev.zip" -o _site/stash-downloader-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser.zip" -o _site/stash-browser.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser-dev.zip" -o _site/stash-browser-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-tagger-dev.zip" -o _site/stash-tagger-dev.zip || true
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || true

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}

          echo "" > _site/index.yml

          # Tagger Stable (NEW)
          HASH=$(sha256sum _site/stash-tagger.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-tagger
            name: Stash Tagger
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-tagger.zip
            sha256: ${HASH}
            description: Match studios, performers, and tags from StashBox
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Version fallbacks from current package.json (not 0.0.0)
          TAGGER_FALLBACK="${{ steps.version.outputs.version }}"
          DOWNLOADER_FALLBACK="${{ steps.version.outputs.downloader_version }}"
          BROWSER_FALLBACK="${{ steps.version.outputs.browser_version }}"

          # Preserve other entries with proper fallbacks
          for entry in "stash-downloader" "stash-downloader-dev" "stash-browser" "stash-browser-dev" "stash-tagger-dev"; do
            ZIP="_site/${entry}.zip"
            if [[ -f "$ZIP" ]]; then
              HASH=$(sha256sum "$ZIP" | awk '{print $1}')

              # Extract values with proper empty handling (version is 2 lines after id)
              VERSION_ENTRY=$(grep -A2 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | sed 's/.*version: *//' | tr -d '[:space:]')
              DATE_ENTRY=$(grep -A3 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: *//')
              NAME=$(grep -A1 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "name:" | sed 's/.*name: *//')
              DESC=$(grep -A6 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "description:" | sed 's/.*description: *//')

              # Apply fallbacks - use package.json versions for STABLE entries only
              # Dev entries should keep their -dev.sha suffix from existing index
              if [[ -z "$VERSION_ENTRY" ]]; then
                if [[ "$entry" == *"browser"* ]]; then
                  VERSION_ENTRY="${BROWSER_FALLBACK}"
                elif [[ "$entry" == *"tagger"* ]]; then
                  VERSION_ENTRY="${TAGGER_FALLBACK}"
                else
                  VERSION_ENTRY="${DOWNLOADER_FALLBACK}"
                fi
              fi
              [[ -z "$DATE_ENTRY" ]] && DATE_ENTRY="${CURRENT_DATETIME}"
              [[ -z "$NAME" ]] && NAME="${entry}"
              [[ -z "$DESC" ]] && DESC="Stash plugin"

              cat >> _site/index.yml << EOF
          - id: ${entry}
            name: ${NAME}
            version: ${VERSION_ENTRY}
            date: ${DATE_ENTRY}
            path: ${entry}.zip
            sha256: ${HASH}
            description: ${DESC}
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
            fi
          done

          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: tagger-stable-zip
          path: _site/stash-tagger.zip

  # ============================================================================
  # RELEASE DOWNLOADER - Creates GitHub Release for Downloader
  # ============================================================================
  release-downloader:
    needs: deploy-downloader-stable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/downloader-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: downloader-stable-zip

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          # Get all downloader tags sorted by version (newest first)
          ALL_TAGS=$(git tag -l 'downloader-v*' --sort=-v:refname)

          # Find the tag immediately before current
          PREV_TAG=""
          FOUND_CURRENT=false
          for tag in $ALL_TAGS; do
            if [ "$FOUND_CURRENT" = "true" ]; then
              PREV_TAG="$tag"
              break
            fi
            if [ "$tag" = "$CURRENT_TAG" ]; then
              FOUND_CURRENT=true
            fi
          done

          if [ -z "$PREV_TAG" ]; then
            echo "first_release=true" >> $GITHUB_OUTPUT
            echo "prev_tag=" >> $GITHUB_OUTPUT
            echo "First release detected"
          else
            echo "first_release=false" >> $GITHUB_OUTPUT
            echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
            echo "Previous tag: $PREV_TAG"
          fi

      - name: Get changelog and diff analysis
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ github.ref_name }}"
          PLUGIN_PATHS="plugins/stash-downloader/ shared/"

          if [ "${{ steps.prev_tag.outputs.first_release }}" = "true" ]; then
            # First release - get recent commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" -30 -- $PLUGIN_PATHS 2>/dev/null || echo "Initial release")
            DIFF_STAT="Initial release - all files are new"
            DIFF_SUMMARY=""
          else
            # Commits between tags, ONLY for this plugin's paths
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" -- $PLUGIN_PATHS 2>/dev/null)

            # If no commits for this plugin, note that
            if [ -z "$COMMITS" ]; then
              COMMITS="No direct changes to plugin code (dependency or config updates only)"
            fi

            # Diff statistics for this plugin only
            DIFF_STAT=$(git diff ${PREV_TAG}..${CURRENT_TAG} --stat -- $PLUGIN_PATHS 2>/dev/null || echo "")

            # Get summary of actual changes (additions/deletions per file)
            DIFF_SUMMARY=$(git diff ${PREV_TAG}..${CURRENT_TAG} --numstat -- $PLUGIN_PATHS 2>/dev/null | awk '{added+=$1; deleted+=$2; print $3": +"$1"/-"$2} END {print "\nTotal: +"added"/-"deleted" lines"}' || echo "")
          fi

          # Output using heredoc (safe for multiline)
          {
            echo "commits<<COMMITS_EOF"
            echo "$COMMITS"
            echo "COMMITS_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_stat<<DIFFSTAT_EOF"
            echo "$DIFF_STAT"
            echo "DIFFSTAT_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_summary<<DIFFSUMMARY_EOF"
            echo "$DIFF_SUMMARY"
            echo "DIFFSUMMARY_EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate AI release notes
        id: ai_notes
        continue-on-error: true
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "No GOOGLE_API_KEY configured, skipping AI release notes"
            exit 0
          fi

          VERSION="${{ needs.deploy-downloader-stable.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          FIRST_RELEASE="${{ steps.prev_tag.outputs.first_release }}"

          # Build context file to avoid shell escaping issues
          cat > /tmp/release_context.txt << 'CONTEXT_EOF'
          PLUGIN: Stash Downloader
          DESCRIPTION: A Stash plugin for downloading videos/images from URLs with automatic metadata extraction using yt-dlp.

          COMMITS (changes specific to this plugin only):
          ${{ steps.changelog.outputs.commits }}

          FILE CHANGES:
          ${{ steps.changelog.outputs.diff_stat }}

          CHANGE SUMMARY:
          ${{ steps.changelog.outputs.diff_summary }}
          CONTEXT_EOF

          # Build the prompt
          if [ "$FIRST_RELEASE" = "true" ]; then
            COMPARE_LINK="Initial release"
            ANALYSIS_INSTRUCTION="This is the first release, so summarize the initial feature set."
          else
            COMPARE_LINK="[Full Changelog](https://github.com/Codename-11/Stash-Downloader/compare/${PREV_TAG}...${VERSION})"
            ANALYSIS_INSTRUCTION="Analyze the commits and file changes to determine the NET changes. Look for:
          - Features added then removed (reversion) - don't mention these
          - Features that were refactored multiple times - summarize the final state only
          - Bug fixes that were later reverted - don't mention these
          Focus on what ACTUALLY changed from the user's perspective between releases."
          fi

          PROMPT="Generate release notes for Stash Downloader v${VERSION}.

          $(cat /tmp/release_context.txt)

          IMPORTANT ANALYSIS RULES:
          ${ANALYSIS_INSTRUCTION}
          - ONLY include changes from the COMMITS section above - these are filtered to this plugin only
          - Do NOT mention changes to other plugins (stash-browser, browser-extension)
          - If a feature was added then removed between releases, it's net zero - don't mention it

          Format the response EXACTLY like this:
          ## ðŸš€ Stash Downloader v${VERSION}

          ### âœ¨ What's New

          **Feature Name** â€” Brief description of what it does.

          (repeat for each significant user-facing change)

          ${COMPARE_LINK}

          ### ðŸ“ All Changes

          - âœ¨ feat: description
          - ðŸ› fix: description
          - â™»ï¸ refactor: description

          ---

          ### ðŸ“¦ Installation

          **Via Stash Plugin Manager (Recommended):**
          1. Settings â†’ Plugins â†’ Available Plugins â†’ Add Source
          2. Enter: \`https://codename-11.github.io/Stash-Downloader/index.yml\`
          3. Find \"Stash Downloader\" and click Install

          **Manual Installation:**
          1. Download \`stash-downloader.zip\` below
          2. Extract to \`~/.stash/plugins/stash-downloader/\`
          3. Reload plugins in Stash

          ### ðŸ“‹ Requirements
          - Stash v0.20+
          - Python 3.7+ with yt-dlp (\`pip install yt-dlp\`)

          Rules:
          - Be concise - one line per feature
          - Focus on user-facing changes only
          - Skip internal refactoring from What's New (keep in All Changes)
          - If no significant changes, say 'Maintenance release with minor improvements'"

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GOOGLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"contents\":[{\"parts\":[{\"text\":$(echo "$PROMPT" | jq -Rs .)}]}]}")

          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "::warning::Gemini API error: $ERROR"
            exit 0
          fi

          NOTES=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
          if [ -z "$NOTES" ]; then
            echo "::warning::Empty response from Gemini"
            exit 0
          fi

          {
            echo "notes<<NOTES_EOF"
            echo "$NOTES"
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Stash Downloader v${{ needs.deploy-downloader-stable.outputs.version }}"
          body: ${{ steps.ai_notes.outputs.notes }}
          files: stash-downloader.zip
          generate_release_notes: ${{ steps.ai_notes.outputs.notes == '' }}

  # ============================================================================
  # RELEASE BROWSER - Creates GitHub Release for Browser
  # ============================================================================
  release-browser:
    needs: deploy-browser-stable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/browser-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: browser-stable-zip

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          # Get all browser tags sorted by version (newest first)
          ALL_TAGS=$(git tag -l 'browser-v*' --sort=-v:refname)

          # Find the tag immediately before current
          PREV_TAG=""
          FOUND_CURRENT=false
          for tag in $ALL_TAGS; do
            if [ "$FOUND_CURRENT" = "true" ]; then
              PREV_TAG="$tag"
              break
            fi
            if [ "$tag" = "$CURRENT_TAG" ]; then
              FOUND_CURRENT=true
            fi
          done

          if [ -z "$PREV_TAG" ]; then
            echo "first_release=true" >> $GITHUB_OUTPUT
            echo "prev_tag=" >> $GITHUB_OUTPUT
            echo "First release detected"
          else
            echo "first_release=false" >> $GITHUB_OUTPUT
            echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
            echo "Previous tag: $PREV_TAG"
          fi

      - name: Get changelog and diff analysis
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ github.ref_name }}"
          PLUGIN_PATHS="plugins/stash-browser/ shared/"

          if [ "${{ steps.prev_tag.outputs.first_release }}" = "true" ]; then
            # First release - get recent commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" -30 -- $PLUGIN_PATHS 2>/dev/null || echo "Initial release")
            DIFF_STAT="Initial release - all files are new"
            DIFF_SUMMARY=""
          else
            # Commits between tags, ONLY for this plugin's paths
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" -- $PLUGIN_PATHS 2>/dev/null)

            # If no commits for this plugin, note that
            if [ -z "$COMMITS" ]; then
              COMMITS="No direct changes to plugin code (dependency or config updates only)"
            fi

            # Diff statistics for this plugin only
            DIFF_STAT=$(git diff ${PREV_TAG}..${CURRENT_TAG} --stat -- $PLUGIN_PATHS 2>/dev/null || echo "")

            # Get summary of actual changes (additions/deletions per file)
            DIFF_SUMMARY=$(git diff ${PREV_TAG}..${CURRENT_TAG} --numstat -- $PLUGIN_PATHS 2>/dev/null | awk '{added+=$1; deleted+=$2; print $3": +"$1"/-"$2} END {print "\nTotal: +"added"/-"deleted" lines"}' || echo "")
          fi

          # Output using heredoc (safe for multiline)
          {
            echo "commits<<COMMITS_EOF"
            echo "$COMMITS"
            echo "COMMITS_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_stat<<DIFFSTAT_EOF"
            echo "$DIFF_STAT"
            echo "DIFFSTAT_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_summary<<DIFFSUMMARY_EOF"
            echo "$DIFF_SUMMARY"
            echo "DIFFSUMMARY_EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate AI release notes
        id: ai_notes
        continue-on-error: true
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "No GOOGLE_API_KEY configured, skipping AI release notes"
            exit 0
          fi

          VERSION="${{ needs.deploy-browser-stable.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          FIRST_RELEASE="${{ steps.prev_tag.outputs.first_release }}"

          # Build context file to avoid shell escaping issues
          cat > /tmp/release_context.txt << 'CONTEXT_EOF'
          PLUGIN: Stash Browser
          DESCRIPTION: A Stash plugin for browsing booru sites (Rule34, Gelbooru, Danbooru) and adding content to the Stash Downloader queue.

          COMMITS (changes specific to this plugin only):
          ${{ steps.changelog.outputs.commits }}

          FILE CHANGES:
          ${{ steps.changelog.outputs.diff_stat }}

          CHANGE SUMMARY:
          ${{ steps.changelog.outputs.diff_summary }}
          CONTEXT_EOF

          # Build the prompt
          if [ "$FIRST_RELEASE" = "true" ]; then
            COMPARE_LINK="Initial release"
            ANALYSIS_INSTRUCTION="This is the first release, so summarize the initial feature set."
          else
            COMPARE_LINK="[Full Changelog](https://github.com/Codename-11/Stash-Downloader/compare/${PREV_TAG}...${VERSION})"
            ANALYSIS_INSTRUCTION="Analyze the commits and file changes to determine the NET changes. Look for:
          - Features added then removed (reversion) - don't mention these
          - Features that were refactored multiple times - summarize the final state only
          - Bug fixes that were later reverted - don't mention these
          Focus on what ACTUALLY changed from the user's perspective between releases."
          fi

          PROMPT="Generate release notes for Stash Browser v${VERSION}.

          $(cat /tmp/release_context.txt)

          IMPORTANT ANALYSIS RULES:
          ${ANALYSIS_INSTRUCTION}
          - ONLY include changes from the COMMITS section above - these are filtered to this plugin only
          - Do NOT mention changes to other plugins (stash-downloader, browser-extension)
          - If a feature was added then removed between releases, it's net zero - don't mention it

          Format the response EXACTLY like this:
          ## ðŸ” Stash Browser v${VERSION}

          ### âœ¨ What's New

          **Feature Name** â€” Brief description of what it does.

          (repeat for each significant user-facing change)

          ${COMPARE_LINK}

          ### ðŸ“ All Changes

          - âœ¨ feat: description
          - ðŸ› fix: description
          - â™»ï¸ refactor: description

          ---

          ### ðŸ“¦ Installation

          **Via Stash Plugin Manager (Recommended):**
          1. Settings â†’ Plugins â†’ Available Plugins â†’ Add Source
          2. Enter: \`https://codename-11.github.io/Stash-Downloader/index.yml\`
          3. Find \"Stash Browser\" and click Install

          **Manual Installation:**
          1. Download \`stash-browser.zip\` below
          2. Extract to \`~/.stash/plugins/stash-browser/\`
          3. Reload plugins in Stash

          ### ðŸ“‹ Requirements
          - Stash v0.20+
          - **Stash Downloader plugin** (for queue integration)
          - API credentials for Rule34/Gelbooru (free, get from site settings)

          Rules:
          - Be concise - one line per feature
          - Focus on user-facing changes only
          - Skip internal refactoring from What's New (keep in All Changes)
          - If no significant changes, say 'Maintenance release with minor improvements'"

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GOOGLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"contents\":[{\"parts\":[{\"text\":$(echo "$PROMPT" | jq -Rs .)}]}]}")

          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "::warning::Gemini API error: $ERROR"
            exit 0
          fi

          NOTES=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
          if [ -z "$NOTES" ]; then
            echo "::warning::Empty response from Gemini"
            exit 0
          fi

          {
            echo "notes<<NOTES_EOF"
            echo "$NOTES"
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Stash Browser v${{ needs.deploy-browser-stable.outputs.version }}"
          body: ${{ steps.ai_notes.outputs.notes }}
          files: stash-browser.zip
          generate_release_notes: ${{ steps.ai_notes.outputs.notes == '' }}

  # ============================================================================
  # RELEASE TAGGER - Creates GitHub Release for Tagger
  # ============================================================================
  release-tagger:
    needs: deploy-tagger-stable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/tagger-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: tagger-stable-zip

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          # Get all tagger tags sorted by version (newest first)
          ALL_TAGS=$(git tag -l 'tagger-v*' --sort=-v:refname)

          # Find the tag immediately before current
          PREV_TAG=""
          FOUND_CURRENT=false
          for tag in $ALL_TAGS; do
            if [ "$FOUND_CURRENT" = "true" ]; then
              PREV_TAG="$tag"
              break
            fi
            if [ "$tag" = "$CURRENT_TAG" ]; then
              FOUND_CURRENT=true
            fi
          done

          if [ -z "$PREV_TAG" ]; then
            echo "first_release=true" >> $GITHUB_OUTPUT
            echo "prev_tag=" >> $GITHUB_OUTPUT
            echo "First release detected"
          else
            echo "first_release=false" >> $GITHUB_OUTPUT
            echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
            echo "Previous tag: $PREV_TAG"
          fi

      - name: Get changelog and diff analysis
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ github.ref_name }}"
          PLUGIN_PATHS="plugins/stash-tagger/ shared/"

          if [ "${{ steps.prev_tag.outputs.first_release }}" = "true" ]; then
            # First release - get recent commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" -30 -- $PLUGIN_PATHS 2>/dev/null || echo "Initial release")
            DIFF_STAT="Initial release - all files are new"
            DIFF_SUMMARY=""
          else
            # Commits between tags, ONLY for this plugin's paths
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" -- $PLUGIN_PATHS 2>/dev/null)

            # If no commits for this plugin, note that
            if [ -z "$COMMITS" ]; then
              COMMITS="No direct changes to plugin code (dependency or config updates only)"
            fi

            # Diff statistics for this plugin only
            DIFF_STAT=$(git diff ${PREV_TAG}..${CURRENT_TAG} --stat -- $PLUGIN_PATHS 2>/dev/null || echo "")

            # Get summary of actual changes (additions/deletions per file)
            DIFF_SUMMARY=$(git diff ${PREV_TAG}..${CURRENT_TAG} --numstat -- $PLUGIN_PATHS 2>/dev/null | awk '{added+=$1; deleted+=$2; print $3": +"$1"/-"$2} END {print "\nTotal: +"added"/-"deleted" lines"}' || echo "")
          fi

          # Output using heredoc (safe for multiline)
          {
            echo "commits<<COMMITS_EOF"
            echo "$COMMITS"
            echo "COMMITS_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_stat<<DIFFSTAT_EOF"
            echo "$DIFF_STAT"
            echo "DIFFSTAT_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_summary<<DIFFSUMMARY_EOF"
            echo "$DIFF_SUMMARY"
            echo "DIFFSUMMARY_EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate AI release notes
        id: ai_notes
        continue-on-error: true
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "No GOOGLE_API_KEY configured, skipping AI release notes"
            exit 0
          fi

          VERSION="${{ needs.deploy-tagger-stable.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          FIRST_RELEASE="${{ steps.prev_tag.outputs.first_release }}"

          # Build context file to avoid shell escaping issues
          cat > /tmp/release_context.txt << 'CONTEXT_EOF'
          PLUGIN: Stash Tagger
          DESCRIPTION: A Stash plugin for matching studios, performers, and tags from StashBox instances (like StashDB) to apply metadata.

          COMMITS (changes specific to this plugin only):
          ${{ steps.changelog.outputs.commits }}

          FILE CHANGES:
          ${{ steps.changelog.outputs.diff_stat }}

          CHANGE SUMMARY:
          ${{ steps.changelog.outputs.diff_summary }}
          CONTEXT_EOF

          # Build the prompt
          if [ "$FIRST_RELEASE" = "true" ]; then
            COMPARE_LINK="Initial release"
            ANALYSIS_INSTRUCTION="This is the first release, so summarize the initial feature set."
          else
            COMPARE_LINK="[Full Changelog](https://github.com/Codename-11/Stash-Downloader/compare/${PREV_TAG}...${VERSION})"
            ANALYSIS_INSTRUCTION="Analyze the commits and file changes to determine the NET changes. Look for:
          - Features added then removed (reversion) - don't mention these
          - Features that were refactored multiple times - summarize the final state only
          - Bug fixes that were later reverted - don't mention these
          Focus on what ACTUALLY changed from the user's perspective between releases."
          fi

          PROMPT="Generate release notes for Stash Tagger v${VERSION}.

          $(cat /tmp/release_context.txt)

          IMPORTANT ANALYSIS RULES:
          ${ANALYSIS_INSTRUCTION}
          - ONLY include changes from the COMMITS section above - these are filtered to this plugin only
          - Do NOT mention changes to other plugins (stash-downloader, stash-browser, browser-extension)
          - If a feature was added then removed between releases, it's net zero - don't mention it

          Format the response EXACTLY like this:
          ## ðŸ·ï¸ Stash Tagger v${VERSION}

          ### âœ¨ What's New

          **Feature Name** â€” Brief description of what it does.

          (repeat for each significant user-facing change)

          ${COMPARE_LINK}

          ### ðŸ“ All Changes

          - âœ¨ feat: description
          - ðŸ› fix: description
          - â™»ï¸ refactor: description

          ---

          ### ðŸ“¦ Installation

          **Via Stash Plugin Manager (Recommended):**
          1. Settings â†’ Plugins â†’ Available Plugins â†’ Add Source
          2. Enter: \`https://codename-11.github.io/Stash-Downloader/index.yml\`
          3. Find \"Stash Tagger\" and click Install

          **Manual Installation:**
          1. Download \`stash-tagger.zip\` below
          2. Extract to \`~/.stash/plugins/stash-tagger/\`
          3. Reload plugins in Stash

          ### ðŸ“‹ Requirements
          - Stash v0.20+
          - At least one StashBox instance configured in Stash settings

          Rules:
          - Be concise - one line per feature
          - Focus on user-facing changes only
          - Skip internal refactoring from What's New (keep in All Changes)
          - If no significant changes, say 'Maintenance release with minor improvements'"

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GOOGLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"contents\":[{\"parts\":[{\"text\":$(echo "$PROMPT" | jq -Rs .)}]}]}")

          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "::warning::Gemini API error: $ERROR"
            exit 0
          fi

          NOTES=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
          if [ -z "$NOTES" ]; then
            echo "::warning::Empty response from Gemini"
            exit 0
          fi

          {
            echo "notes<<NOTES_EOF"
            echo "$NOTES"
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Stash Tagger v${{ needs.deploy-tagger-stable.outputs.version }}"
          body: ${{ steps.ai_notes.outputs.notes }}
          files: stash-tagger.zip
          generate_release_notes: ${{ steps.ai_notes.outputs.notes == '' }}

  # ============================================================================
  # RELEASE EXTENSION - Creates GitHub Release for Firefox Extension
  # ============================================================================
  release-extension:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/extension-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./browser-extension/package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create ZIP package
        run: |
          cd browser-extension
          zip -r stash-downloader-extension.zip \
            manifest.json \
            background.js \
            content.js \
            popup/ \
            options/ \
            icons/ \
            README.md

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          # Get all extension tags sorted by version (newest first)
          ALL_TAGS=$(git tag -l 'extension-v*' --sort=-v:refname)

          # Find the tag immediately before current
          PREV_TAG=""
          FOUND_CURRENT=false
          for tag in $ALL_TAGS; do
            if [ "$FOUND_CURRENT" = "true" ]; then
              PREV_TAG="$tag"
              break
            fi
            if [ "$tag" = "$CURRENT_TAG" ]; then
              FOUND_CURRENT=true
            fi
          done

          if [ -z "$PREV_TAG" ]; then
            echo "first_release=true" >> $GITHUB_OUTPUT
            echo "prev_tag=" >> $GITHUB_OUTPUT
            echo "First release detected"
          else
            echo "first_release=false" >> $GITHUB_OUTPUT
            echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
            echo "Previous tag: $PREV_TAG"
          fi

      - name: Get changelog and diff analysis
        id: changelog
        run: |
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          CURRENT_TAG="${{ github.ref_name }}"
          EXT_PATH="browser-extension/"

          if [ "${{ steps.prev_tag.outputs.first_release }}" = "true" ]; then
            # First release - get recent commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" -20 -- $EXT_PATH 2>/dev/null || echo "Initial release")
            DIFF_STAT="Initial release - all files are new"
            DIFF_SUMMARY=""
          else
            # Commits between tags, ONLY for extension path
            COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" -- $EXT_PATH 2>/dev/null)

            # If no commits for extension, note that
            if [ -z "$COMMITS" ]; then
              COMMITS="No direct changes to extension code (dependency or config updates only)"
            fi

            # Diff statistics for extension only
            DIFF_STAT=$(git diff ${PREV_TAG}..${CURRENT_TAG} --stat -- $EXT_PATH 2>/dev/null || echo "")

            # Get summary of actual changes
            DIFF_SUMMARY=$(git diff ${PREV_TAG}..${CURRENT_TAG} --numstat -- $EXT_PATH 2>/dev/null | awk '{added+=$1; deleted+=$2; print $3": +"$1"/-"$2} END {print "\nTotal: +"added"/-"deleted" lines"}' || echo "")
          fi

          # Output using heredoc (safe for multiline)
          {
            echo "commits<<COMMITS_EOF"
            echo "$COMMITS"
            echo "COMMITS_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_stat<<DIFFSTAT_EOF"
            echo "$DIFF_STAT"
            echo "DIFFSTAT_EOF"
          } >> $GITHUB_OUTPUT

          {
            echo "diff_summary<<DIFFSUMMARY_EOF"
            echo "$DIFF_SUMMARY"
            echo "DIFFSUMMARY_EOF"
          } >> $GITHUB_OUTPUT

      - name: Generate AI release notes
        id: ai_notes
        continue-on-error: true
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -z "$GOOGLE_API_KEY" ]; then
            echo "No GOOGLE_API_KEY configured, skipping AI release notes"
            exit 0
          fi

          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"
          FIRST_RELEASE="${{ steps.prev_tag.outputs.first_release }}"

          # Build context file to avoid shell escaping issues
          cat > /tmp/release_context.txt << 'CONTEXT_EOF'
          PROJECT: Firefox Browser Extension for Stash Downloader
          DESCRIPTION: A Firefox extension that allows users to send URLs directly to their Stash Downloader queue from any webpage via context menu or popup.

          COMMITS (changes specific to this extension only):
          ${{ steps.changelog.outputs.commits }}

          FILE CHANGES:
          ${{ steps.changelog.outputs.diff_stat }}

          CHANGE SUMMARY:
          ${{ steps.changelog.outputs.diff_summary }}
          CONTEXT_EOF

          # Build the prompt
          if [ "$FIRST_RELEASE" = "true" ]; then
            COMPARE_LINK="Initial release"
            ANALYSIS_INSTRUCTION="This is the first release, so summarize the initial feature set."
          else
            COMPARE_LINK="[Full Changelog](https://github.com/Codename-11/Stash-Downloader/compare/${PREV_TAG}...extension-v${VERSION})"
            ANALYSIS_INSTRUCTION="Analyze the commits and file changes to determine the NET changes. Look for:
          - Features added then removed (reversion) - don't mention these
          - Features that were refactored multiple times - summarize the final state only
          - Bug fixes that were later reverted - don't mention these
          Focus on what ACTUALLY changed from the user's perspective between releases."
          fi

          PROMPT="Generate release notes for Stash Downloader Firefox Extension v${VERSION}.

          $(cat /tmp/release_context.txt)

          IMPORTANT ANALYSIS RULES:
          ${ANALYSIS_INSTRUCTION}
          - ONLY include changes from the COMMITS section above - these are filtered to browser-extension/ only
          - Do NOT mention changes to Stash plugins (stash-downloader, stash-browser)
          - If a feature was added then removed between releases, it's net zero - don't mention it

          Format the response EXACTLY like this:
          ## ðŸ¦Š Stash Downloader Extension v${VERSION}

          Firefox browser extension for sending URLs directly to your Stash Downloader queue.

          ### âœ¨ What's New

          **Feature Name** â€” Brief description of what it does.

          (repeat for each significant user-facing change)

          ${COMPARE_LINK}

          ### ðŸ“ All Changes

          - âœ¨ feat: description
          - ðŸ› fix: description
          - â™»ï¸ refactor: description

          ---

          ### ðŸ“¦ Installation

          **From Firefox Add-ons (Recommended):**
          - [Install from AMO](https://addons.mozilla.org/en-US/firefox/addon/stash-downloader-extension/)

          **Manual Installation:**
          1. Download \`stash-downloader-extension.zip\` below
          2. Go to \`about:debugging\` â†’ This Firefox â†’ Load Temporary Add-on
          3. Select the ZIP file

          ### âš ï¸ Note
          After downloading from GitHub, you still need to **submit to AMO** for the public release.
          The ZIP is ready for upload to [Firefox Add-ons Developer Hub](https://addons.mozilla.org/developers/).

          Rules:
          - Be concise - one line per feature
          - Focus on user-facing changes only
          - Skip internal changes from What's New
          - If no significant changes, say 'Maintenance release with minor improvements'"

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GOOGLE_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"contents\":[{\"parts\":[{\"text\":$(echo "$PROMPT" | jq -Rs .)}]}]}")

          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "::warning::Gemini API error: $ERROR"
            exit 0
          fi

          NOTES=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
          if [ -z "$NOTES" ]; then
            echo "::warning::Empty response from Gemini"
            exit 0
          fi

          {
            echo "notes<<NOTES_EOF"
            echo "$NOTES"
            echo "NOTES_EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Firefox Extension v${{ steps.version.outputs.version }}"
          body: ${{ steps.ai_notes.outputs.notes }}
          files: browser-extension/stash-downloader-extension.zip
          generate_release_notes: ${{ steps.ai_notes.outputs.notes == '' }}
