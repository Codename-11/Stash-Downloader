name: CI/CD

on:
  push:
    branches: [dev]
    tags:
      - 'downloader-v*'  # Stash Downloader releases
      - 'browser-v*'     # Stash Browser releases
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_dev:
        description: 'Deploy as dev build'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  PAGES_URL: "https://codename-11.github.io/Stash-Downloader"

jobs:
  # ============================================================================
  # TEST JOB - Runs on all pushes and PRs
  # ============================================================================
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

      - name: Run tests (Downloader)
        run: npm test -- --run
        working-directory: plugins/stash-downloader

      - name: Build all plugins
        run: npm run build

  # ============================================================================
  # DEPLOY DEV - Builds BOTH plugins on dev branch push
  # ============================================================================
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: |
      github.ref == 'refs/heads/dev' ||
      (github.event_name == 'workflow_dispatch' && inputs.deploy_dev)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get versions
        id: versions
        run: |
          DOWNLOADER_VERSION=$(node -p "require('./plugins/stash-downloader/package.json').version")
          BROWSER_VERSION=$(node -p "require('./plugins/stash-browser/package.json').version")
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)

          echo "downloader_version=${DOWNLOADER_VERSION}-dev.${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "browser_version=${BROWSER_VERSION}-dev.${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "downloader_base=${DOWNLOADER_VERSION}" >> $GITHUB_OUTPUT
          echo "browser_base=${BROWSER_VERSION}" >> $GITHUB_OUTPUT

      - name: Modify Downloader source for dev
        run: |
          sed -i 's/stash-downloader/stash-downloader-dev/g' plugins/stash-downloader/src/constants/index.ts
          sed -i 's/Stash Downloader/Stash Downloader (Dev)/g' plugins/stash-downloader/src/constants/index.ts
          sed -i 's/stash-downloader-styles/stash-downloader-dev-styles/g' plugins/stash-downloader/src/index.tsx
          sed -i 's/stash-downloader-nav-button/stash-downloader-dev-nav-button/g' plugins/stash-downloader/src/index.tsx
          sed -i 's/name: Stash Downloader$/name: Stash Downloader (Dev)/g' plugins/stash-downloader/stash-downloader.yml
          cd plugins/stash-downloader && npm version ${{ steps.versions.outputs.downloader_version }} --no-git-tag-version --allow-same-version

      - name: Modify Browser source for dev
        run: |
          sed -i 's/stash-browser/stash-browser-dev/g' plugins/stash-browser/src/constants/index.ts
          sed -i 's/Stash Browser/Stash Browser (Dev)/g' plugins/stash-browser/src/constants/index.ts
          sed -i 's/name: Stash Browser$/name: Stash Browser (Dev)/g' plugins/stash-browser/stash-browser.yml
          cd plugins/stash-browser && npm version ${{ steps.versions.outputs.browser_version }} --no-git-tag-version --allow-same-version

      - name: Build all plugins
        run: npm run build

      - name: Create dev packages
        run: |
          mkdir -p _site

          # Package Stash Downloader Dev
          mkdir -p _pkg_downloader
          cp -r plugins/stash-downloader/dist _pkg_downloader/
          cp -r plugins/stash-downloader/scripts _pkg_downloader/
          cp plugins/stash-downloader/stash-downloader.yml _pkg_downloader/stash-downloader-dev.yml
          cp README.md LICENSE _pkg_downloader/
          cd _pkg_downloader && zip -r ../stash-downloader-dev.zip . && cd ..
          mv stash-downloader-dev.zip _site/

          # Package Stash Browser Dev
          mkdir -p _pkg_browser
          cp -r plugins/stash-browser/dist _pkg_browser/
          cp -r plugins/stash-browser/scripts _pkg_browser/
          cp plugins/stash-browser/stash-browser.yml _pkg_browser/stash-browser-dev.yml
          cp LICENSE _pkg_browser/
          cd _pkg_browser && zip -r ../stash-browser-dev.zip . && cd ..
          mv stash-browser-dev.zip _site/

      - name: Fetch existing stable builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader.zip" -o _site/stash-downloader.zip || echo "No existing downloader stable"
          curl -fsSL "${PAGES_URL}/stash-browser.zip" -o _site/stash-browser.zip || echo "No existing browser stable"
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || echo "No existing index"

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')

          # Start fresh index
          echo "" > _site/index.yml

          # Downloader Dev
          HASH=$(sha256sum _site/stash-downloader-dev.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-downloader-dev
            name: Stash Downloader (Dev)
            version: ${{ steps.versions.outputs.downloader_version }}
            date: ${CURRENT_DATETIME}
            path: stash-downloader-dev.zip
            sha256: ${HASH}
            description: "[DEV] Download images/videos with metadata extraction"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Downloader Stable (if exists)
          if [[ -f _site/stash-downloader.zip ]]; then
            HASH=$(sha256sum _site/stash-downloader.zip | awk '{print $1}')
            VERSION=$(grep -A1 "id: stash-downloader$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | awk '{print $2}' || echo "${{ steps.versions.outputs.downloader_base }}")
            DATE=$(grep -A3 "id: stash-downloader$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: //' || echo "${CURRENT_DATETIME}")
            cat >> _site/index.yml << EOF
          - id: stash-downloader
            name: Stash Downloader
            version: ${VERSION}
            date: ${DATE}
            path: stash-downloader.zip
            sha256: ${HASH}
            description: Download images and videos from URLs with automatic metadata extraction
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          # Browser Dev
          HASH=$(sha256sum _site/stash-browser-dev.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-browser-dev
            name: Stash Browser (Dev)
            version: ${{ steps.versions.outputs.browser_version }}
            date: ${CURRENT_DATETIME}
            path: stash-browser-dev.zip
            sha256: ${HASH}
            description: "[DEV] Browse and preview content from external sources"
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Browser Stable (if exists)
          if [[ -f _site/stash-browser.zip ]]; then
            HASH=$(sha256sum _site/stash-browser.zip | awk '{print $1}')
            VERSION=$(grep -A1 "id: stash-browser$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | awk '{print $2}' || echo "${{ steps.versions.outputs.browser_base }}")
            DATE=$(grep -A3 "id: stash-browser$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: //' || echo "${CURRENT_DATETIME}")
            cat >> _site/index.yml << EOF
          - id: stash-browser
            name: Stash Browser
            version: ${VERSION}
            date: ${DATE}
            path: stash-browser.zip
            sha256: ${HASH}
            description: Browse and preview content from external sources
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
          fi

          echo "Generated index.yml:"
          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

  # ============================================================================
  # DEPLOY DOWNLOADER STABLE - Only on downloader-v* tags
  # ============================================================================
  deploy-downloader-stable:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/downloader-v')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./plugins/stash-downloader/package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create package
        run: |
          mkdir -p _site _package
          cp -r plugins/stash-downloader/dist _package/
          cp -r plugins/stash-downloader/scripts _package/
          cp plugins/stash-downloader/stash-downloader.yml _package/
          cp README.md LICENSE _package/
          cd _package && zip -r ../stash-downloader.zip . && cd ..
          mv stash-downloader.zip _site/

      - name: Fetch existing builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader-dev.zip" -o _site/stash-downloader-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser.zip" -o _site/stash-browser.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser-dev.zip" -o _site/stash-browser-dev.zip || true
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || true

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}

          echo "" > _site/index.yml

          # Downloader Stable (NEW)
          HASH=$(sha256sum _site/stash-downloader.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-downloader
            name: Stash Downloader
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-downloader.zip
            sha256: ${HASH}
            description: Download images and videos from URLs with automatic metadata extraction
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Preserve other entries
          for entry in "stash-downloader-dev" "stash-browser" "stash-browser-dev"; do
            ZIP="_site/${entry}.zip"
            if [[ -f "$ZIP" ]]; then
              HASH=$(sha256sum "$ZIP" | awk '{print $1}')
              VERSION_ENTRY=$(grep -A1 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | awk '{print $2}' || echo "0.0.0")
              DATE_ENTRY=$(grep -A3 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: //' || echo "${CURRENT_DATETIME}")
              NAME=$(grep -A2 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "name:" | sed 's/.*name: //' || echo "${entry}")
              DESC=$(grep -A5 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "description:" | sed 's/.*description: //' || echo "Stash plugin")
              cat >> _site/index.yml << EOF
          - id: ${entry}
            name: ${NAME}
            version: ${VERSION_ENTRY}
            date: ${DATE_ENTRY}
            path: ${entry}.zip
            sha256: ${HASH}
            description: ${DESC}
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
            fi
          done

          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: downloader-stable-zip
          path: _site/stash-downloader.zip

  # ============================================================================
  # DEPLOY BROWSER STABLE - Only on browser-v* tags
  # ============================================================================
  deploy-browser-stable:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/browser-v')
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./plugins/stash-browser/package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create package
        run: |
          mkdir -p _site _package
          cp -r plugins/stash-browser/dist _package/
          cp -r plugins/stash-browser/scripts _package/
          cp plugins/stash-browser/stash-browser.yml _package/
          cp LICENSE _package/
          cd _package && zip -r ../stash-browser.zip . && cd ..
          mv stash-browser.zip _site/

      - name: Fetch existing builds
        continue-on-error: true
        run: |
          curl -fsSL "${PAGES_URL}/stash-downloader.zip" -o _site/stash-downloader.zip || true
          curl -fsSL "${PAGES_URL}/stash-downloader-dev.zip" -o _site/stash-downloader-dev.zip || true
          curl -fsSL "${PAGES_URL}/stash-browser-dev.zip" -o _site/stash-browser-dev.zip || true
          curl -fsSL "${PAGES_URL}/index.yml" -o /tmp/existing-index.yml || true

      - name: Copy docs
        run: |
          if [ -d "docs" ]; then cp -r docs/* _site/; fi

      - name: Generate index.yml
        run: |
          CURRENT_DATETIME=$(TZ='America/New_York' date +'%Y-%m-%d %H:%M:%S')
          VERSION=${{ steps.version.outputs.version }}

          echo "" > _site/index.yml

          # Browser Stable (NEW)
          HASH=$(sha256sum _site/stash-browser.zip | awk '{print $1}')
          cat >> _site/index.yml << EOF
          - id: stash-browser
            name: Stash Browser
            version: ${VERSION}
            date: ${CURRENT_DATETIME}
            path: stash-browser.zip
            sha256: ${HASH}
            description: Browse and preview content from external sources
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF

          # Preserve other entries
          for entry in "stash-downloader" "stash-downloader-dev" "stash-browser-dev"; do
            ZIP="_site/${entry}.zip"
            if [[ -f "$ZIP" ]]; then
              HASH=$(sha256sum "$ZIP" | awk '{print $1}')
              VERSION_ENTRY=$(grep -A1 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "version:" | awk '{print $2}' || echo "0.0.0")
              DATE_ENTRY=$(grep -A3 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "date:" | sed 's/.*date: //' || echo "${CURRENT_DATETIME}")
              NAME=$(grep -A2 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "name:" | sed 's/.*name: //' || echo "${entry}")
              DESC=$(grep -A5 "id: ${entry}$" /tmp/existing-index.yml 2>/dev/null | grep "description:" | sed 's/.*description: //' || echo "Stash plugin")
              cat >> _site/index.yml << EOF
          - id: ${entry}
            name: ${NAME}
            version: ${VERSION_ENTRY}
            date: ${DATE_ENTRY}
            path: ${entry}.zip
            sha256: ${HASH}
            description: ${DESC}
            url: ${{ github.server_url }}/${{ github.repository }}
          EOF
            fi
          done

          cat _site/index.yml

      - name: Deploy to GitHub Pages
        uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      - uses: actions/deploy-pages@v4

      - name: Upload artifact for release
        uses: actions/upload-artifact@v4
        with:
          name: browser-stable-zip
          path: _site/stash-browser.zip

  # ============================================================================
  # RELEASE DOWNLOADER - Creates GitHub Release for Downloader
  # ============================================================================
  release-downloader:
    needs: deploy-downloader-stable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/downloader-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: downloader-stable-zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Stash Downloader v${{ needs.deploy-downloader-stable.outputs.version }}"
          files: stash-downloader.zip
          generate_release_notes: true

  # ============================================================================
  # RELEASE BROWSER - Creates GitHub Release for Browser
  # ============================================================================
  release-browser:
    needs: deploy-browser-stable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/browser-v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: browser-stable-zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Stash Browser v${{ needs.deploy-browser-stable.outputs.version }}"
          files: stash-browser.zip
          generate_release_notes: true
